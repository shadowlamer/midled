#include "stm32f1xx.h" 
#include "spi.h"
#include "sdcard.h"

#define GO_IDLE_STATE 0 											//??????????? ????????????
#define SEND_IF_COND 8 												//??? SDC V2 - ???????? ????????? ??????????
#define READ_SINGLE_BLOCK 17 									//?????? ?????????? ????? ??????
#define WRITE_SINGLE_BLOCK 24 								//?????? ?????????? ????? ??????
#define SD_SEND_OP_COND 41 										//?????? ???????? ?????????????
#define APP_CMD 55 														//??????? ??????? ?? ACMD ??????
#define READ_OCR 58 													//?????? ???????? OCR

//?????????? ?????????? ??? ??????????? ???? ????? 
uint8_t  SDHC;            
//???????????????? ??? ?????????? ??????? SS
#define CS_ENABLE  GPIOA->BRR = GPIO_PIN_4;
#define CS_DISABLE GPIOA->BSRR = GPIO_PIN_4;




//*********************************************************************************************
//function  ????? ??????? ?? SPI1                                                            //
//argument  ???????????? ????                                                                //
//return    ???????? ????                                                                    //
//*********************************************************************************************
uint8_t spi_send (uint8_t txdata)
{ 
/*	uint8_t rxdata = 0xff;
	SET_BIT(hspi1.Instance->CR2, SPI_RXFIFO_THRESHOLD);
  if((hspi1.Instance->CR1 &SPI_CR1_SPE) != SPI_CR1_SPE)
  {
    __HAL_SPI_ENABLE(&hspi1);
  }
	while(__HAL_SPI_GET_FLAG(&hspi1, SPI_FLAG_TXE) == RESET);	
	hspi1.Instance->DR = txdata;
	SET_BIT(hspi1.Instance->CR2, SPI_RXFIFO_THRESHOLD);
	while(__HAL_SPI_GET_FLAG(&hspi1, SPI_FLAG_RXNE) == RESET);	
  rxdata = hspi1.Instance->DR;
  return rxdata; */
	uint8_t rxdata = 0xff;
	HAL_SPI_TransmitReceive(&hspi1, &txdata, &rxdata, sizeof txdata, 0); 
  return rxdata;
	
	
}

//*********************************************************************************************
//function  ????? ???? ?? SPI1                                                               //
//argument  none                                                                             //
//return    ???????? ????                                                                    //
//*********************************************************************************************
uint8_t spi_read (void)
{ 
  return spi_send(0xff);		  //?????? ???????? ??????
}

//********************************************************************************************
//function	 ??????? ??????? ? SD                                		            //
//Arguments	 ??????? ? ?? ????????                                                      //
//return	 0xff - ??? ??????   			                                    //
//********************************************************************************************
uint8_t SD_sendCommand(uint8_t cmd, uint32_t arg)
{
  uint8_t response, wait=0, tmp;     
 
  //??? ???? ?????? SD ????????? ????????? ??????, ?.?. ??? ??? ????????? ????????? 
  if(SDHC == 0)		
  if(cmd == READ_SINGLE_BLOCK || cmd == WRITE_SINGLE_BLOCK )  {arg = arg << 9;}
  //??? SDHC ????????? ?????? ????? ????????? ?? ?????(???????????? ?????????)	
 
  CS_ENABLE;
 
  //???????? ??? ??????? ? ?? ????????
  spi_send(cmd | 0x40);
  spi_send(arg>>24);
  spi_send(arg>>16);
  spi_send(arg>>8);
  spi_send(arg);
 
  //???????? CRC (????????? ?????? ??? ???? ??????)
  if(cmd == SEND_IF_COND) spi_send(0x87);            
  else                    spi_send(0x95); 
 
  //??????? ?????
  while((response = spi_read()) == 0xff) 
   if(wait++ > 0xfe) break;                //???????, ?? ???????? ????? ?? ???????
 
  //???????? ?????? ???? ?????????? ??????? READ_OCR
  if(response == 0x00 && cmd == 58)     
  {
    tmp = spi_read();                      //????????? ???? ???? ???????? OCR            
    if(tmp & 0x40) SDHC = 1;               //?????????? ????? SDHC 
    else           SDHC = 0;               //?????????? ????? SD
    //????????? ??? ?????????? ????? ???????? OCR
    spi_read(); 
    spi_read(); 
    spi_read(); 
  }
 
  spi_read();
 
  CS_DISABLE; 
 
  return response;
}

//********************************************************************************************
//function	 ????????????? ????? ??????                         			    //
//return	 0 - ????? ????????????????  					            //
//********************************************************************************************
uint8_t SD_init(void)
{	
  uint8_t   i;
  uint8_t   response;
  uint8_t   SD_version = 2;	          //?? ????????? ?????? SD = 2
  uint16_t  retry = 0 ;
 
  for(i=0;i<10;i++) spi_send(0xff);      //??????? ????? 74 ??????   
 
  //???????? ??????????? ????? ?????
//  CS_ENABLE;
  while((response=SD_sendCommand(GO_IDLE_STATE, 0))!=0x01) {
		retry++;
    if(retry > 20)  
			return 1;
	}	

//  CS_DISABLE;
  spi_send (0xff);
  spi_send (0xff);

  retry = 0;                                     
  while(SD_sendCommand(SEND_IF_COND,0x000001AA)!=0x01)
  { 
    if(retry++>0xfe) 
    { 
      SD_version = 1;
      break;
    } 
  }
 
 retry = 0;                                     
 do
 {
   response = SD_sendCommand(APP_CMD,0); 
   response = SD_sendCommand(SD_SEND_OP_COND,0x40000000);
   retry++;
   if(retry>0xffe) return response;                     
 }while(response != 0x00);                      
 
 
 //?????? ??????? OCR, ????? ?????????? ??? ?????
 retry = 0;
 SDHC = 0;
 if (SD_version == 2)
 { 
   while(SD_sendCommand(READ_OCR,0)!=0x00)
	 if(retry++>0xfe)  break;
 }
 
 return 0; 
}

//********************************************************************************************
//function	 ?????? ?????????? ??????? SD                         			    //
//?rguments	 ????? ???????,????????? ?? ????? ???????? 512 ????                         //
//return	 0 - ?????? ???????? ???????   					            //
//********************************************************************************************
uint8_t SD_ReadSector(uint32_t BlockNumb,uint8_t *buff)
{ 
  uint16_t i=0;
	uint8_t rxdata = 0xff;

//	HAL_SuspendTick();
  if(SD_sendCommand(READ_SINGLE_BLOCK, BlockNumb)) return 1;  
  CS_ENABLE;
  //????????  ??????? ??????
  while(spi_read() != 0xfe)                
		if(i++ > 0xfffe) {CS_DISABLE; return 1;}       
		while(hspi1.State != HAL_SPI_STATE_READY);
		HAL_SPI_TransmitReceive_DMA(&hspi1,&rxdata,buff,512);
		while(hspi1.State != HAL_SPI_STATE_READY);
 
  spi_read(); 
  spi_read(); 
  spi_read(); 
 
  CS_DISABLE;
//	HAL_ResumeTick();
 
  return 0;
}

//********************************************************************************************
//function	 ?????? ?????????? ??????? SD                         			    //
//?rguments	 ????? ???????, ????????? ?? ?????? ??? ??????                              //
//return	 0 - ?????? ??????? ???????   					            //
//********************************************************************************************
uint8_t SD_WriteSector(uint32_t BlockNumb,uint8_t *buff)
{
  uint8_t     response;
  uint16_t    i,wait=0;
 
  //??????? ??????? "?????? ?????? ?????" ? ????????? ??? ??????
  if( SD_sendCommand(WRITE_SINGLE_BLOCK, BlockNumb)) return 1;
 
  CS_ENABLE;
  spi_send(0xfe);    
 
  //???????? ????? ??????? ? ?????
  for(i=0; i<SD_SECTOR_SIZE; i++) spi_send(*buff++);
 
  spi_send(0xff);                //?????? 2 ????? CRC ??? ??? ????????
  spi_send(0xff);
 
  response = spi_read();
 
  if( (response & 0x1f) != 0x05) //???? ?????? ??? ?????? ?????? ??????
  { CS_DISABLE; return 1; }
 
  //??????? ????????? ?????? ????? ??????
  while(!spi_read())             //???? ????? ??????,??? ?????? ????
  if(wait++ > 0xfffe){CS_DISABLE; return 1;}
 
  CS_DISABLE;
  spi_send(0xff);   
  CS_ENABLE;         
 
  while(!spi_read())               //???? ????? ??????,??? ?????? ????
  if(wait++ > 0xfffe){CS_DISABLE; return 1;}
  CS_DISABLE;
 
  return 0;
}


//	????????
void delay(unsigned long p)
{
	while(p>0){p--;}
}
